#!/bin/bash

# SPDX-FileCopyrightText: 2021-2026 Ole Tange, http://ole.tange.dk and Free Software and Foundation, Inc.
#
# SPDX-License-Identifier: GPL-3.0-or-later

# Usage:
#   vm start freebsd14

start() {
    vm=$1
    is_centos3() {
	echo $vm | grep -q centos3
    }
    centos3_configure_eth1() {
	cat ../../authorized_keys | vagrant ssh -c "cat >>.ssh/authorized_keys"
	vagrant ssh -c "sudo /sbin/ifconfig eth1 172.27.27.3"
    }
    if pingsshok $vm ; then
	true
    else
	# Server does not respond to ping or ssh: vagrant up
	if cdvm $vm ; then
	    echo vagrant up $vm
	    vagrant up
	    if is_centos3 ; then
		centos3_configure_eth1
	    fi
	    # Remove host from known_hosts
	    stdout ssh-keygen -R $vm
	    # Trust on first use ssh
	    stdout wssh -oStrictHostKeyChecking=accept-new vagrant@$vm echo ssh $vm started and works
	else
	    echo $vm dir not found
	fi
    fi |
	grep -Ev "^$|bytes.of.data|ping.statistics|packets.transmitted|64.bytes.from|min/avg/max/mdev|default|known.hosts|Host.*found"
}

stop() {
    vm=$1
    if cleanping $vm ; then
	if cdvm $vm ; then
	    vagrant suspend
	fi
    fi |
	grep -Ev "bytes.of.data|ping.statistics|packets.transmitted|64.bytes.from|min/avg/max/mdev|default|known.hosts|Host.*found"
}

halt() {
    vm=$1
    if cdvm $vm ; then
	vagrant halt
    fi
}

snapshot() {
    vm=$1
    if cdvm $vm ; then
	vagrant snapshot save running-$$
    fi
}

restoresnapshot() {
    vm=$1
    if pingsshok ; then
	true
    else
	if cdvm $vm ; then
	    vagrant snapshot restore $(vagrant snapshot list | tail -1) &&
		sshok vm
	fi
    fi
}

helperfunctions() {
    true
}

cdvm() {
    vm=$1
    if cd vagrant*/*/$vm ; then
	true
    else
	echo $vm dir not found
	false
    fi
}    

cleanping() {
    host=$1
    ping -w 1 -c 1 "$host" >/dev/null 2>&1
}

sshok() {
    host=$1
    ssh vagrant@$host echo ssh vagrant@$host OK
}

pingsshok() {
    host=$1
    cleanping $host && sshok $host
}

"$@"

